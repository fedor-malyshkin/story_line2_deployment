# Код развёртывания/конфигурирования проекта

При определении того, как образом будет организовано развёртывание проекта необходимо было решить следующие вопросы:
1.    как реализовать организовано развёртывание проекта таким образом, что бы максимально повторно использовать средства те же самые скрипты/средства автоматизации/скрипты для разврётывания всех видов стендов? Т.е. обеспечить их схожесть.
1.    Как обеспечить развёртывание стендов в максимально короткие сроки (избегая повторного создания двоичных артефактов на машинах для их развёртывания)
1.    Как организовать развёртывание «development» / «test» стэндов с текущими артефактами (возможно SNAPSHOT), а на «production» - стэнде с указанными версиями?

В итоге были сформулированы следующие требования:
1. повторное использование скриптов (с минимальными отклонениями для видов стенда)
1. «production» – версии артефактов из конфига
1. «development» / «test» - версии артефактов из ветки
1. отсутствие исходных кодов на «production»-стэнде, только готовые артефакты

### Основные средства автоматизации
- [gradle](http://gradle.org/) для оркестрации
- [docker-compose](https://docs.docker.com/compose/) для управления группой контейнеров
- [docker](https://docs.docker.com/) (один контейнер на сервис) для стендов test/development
- [puppet](https://puppet.com/) (для управления конфигурациями и структурой ОС внутри контейнера)

## О структуре проекта
- "modules" - puppet-модули
- "production" - production-специфичные скрипты, БД Hiera и `sites.pp`
- "test" - test-специфичные скрипты, БД Hiera и `sites.pp`
- "teststand" - специфичные скрипты для тестового стенда, БД Hiera и `sites.pp`
- provision_production.sh - provision-код для production-сегмента (должен запускаться на периодичной основе на сервере)
- provision_test.sh - provision-код для  тестового сегмента (должен запускаться на периодичной основе на сервере)
- provision_teststand.sh - provision-код для  тестового стенда (должен запускаться на периодичной основе на сервере)

## О стендах
### О всех видах стендов
- существует несколько видов стэнда:
	* development - стенд для разработки в котором всё ПО запускается вручную, кроме
	инфраструктурных компонентов
	* test - стенд для тестирования в котром все компоненты запускаются в полном
	объме, но стенд "заточен" под задачи тестирования
	* production - полностью продуктивный стэнд
- инициализация сборки стенда осуществляется с помощью задач gradle-скрипта ("buildSrc/build-tasks.gradle")
- тип стенда по-умолчанию (development) может быть переопределён параметром к скрипту
`gradle -Pproject.ext.stand_type=test`

### О "test"/"development"
- стенд представляет собой коллекцию docker-контейнеров
- все параметры скриптов считываются из нескольких конфигурационных файлов,
используемых в зависимости от типа стенда (development/test/production)
- Важное замечание запуск самих контейнеров осуществляется с помощью docker - как следствие должны осуществляться с надлежащими полномочиями.

Последовательность шагов:
1. Осуществляется сборка проекта
1. формируются Dockerfile для контейнера (с учетом параметров)
1. запускается docker-compose (в зависимости от вида стенда)
	2. Выполняется скачивание необходимых образов
	2. Выполняется настройка вида `envoronment` для puppet
	2. выполняются скрипты puppet для подготовки среды в нем
	2. осуществляется запуск контейнера (docker 'ENTRYPOINT')
1. Осуществляется запуск тестов (для test-стэнда)

### О "production"
__TODO__: *вопрос публикации Android-приложения не освещён*

- Фактически самый сложный (и важный) вид развртывания - т.к. фактически происходит обновление серверной части приложения в которой должны обновляеться и корректно запускаться:
 - исполняемые модули
 - конфигурационные файлы
 - инфраструктырные компоненты
- стенд представляет собой фактический сервер на котором работае продуктивная система
- все параметры скриптов считываются из нескольких конфигурационных файлов, используемых в зависимости от типа стенда (development/test/production)
- ключевым файлом процесса является файл с данными о версиях компонентов (__????__) - именно он определяет какие артефакты будут скачиваться при конфигурировании средствами puppet

#### О "production". Настройка среды разработки
Особых требований по развёртыванию нет, однако надо очень аккуратно осуществлять commit'ы - т.к. каждый commit фактически запускает все виды тестов на сервер CI с последующей сменой метки `latest`, что вызовет обновление каталогов на продуктивном сервере с возможным запуском обновления конфигурации.

#### О "production". Настройка сервера CI
При commit в данную в данный проект (а так же может периодически) запускаются все виды тестов с последующей сменой метки `latest` (при их успешном прохождении)

#### О "production". Настройка серверной части
На продуктивном сервере настроено:
- использование `puppet appply` со значением `environment` => "productive"
- на периодической основе:
 1. выполняется `git checkout` данного проекта с меткой `latest` (при котрой получаеются puppet-скрипты, шаблоны конфигурационных файлов, БД Hiera с данными и главное файл с данными о версиях)
 1. выполняется `puppet apply` (в рамках котрого при необходимости обновляются конфигурационные файлы, обновляются исполняемые модули (скачиваются из репозитария), перезапускаются службы, выполняются прочие изменения)
